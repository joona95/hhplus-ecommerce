## 인기 상품 목록 조회 성능 이슈 가능성 분석

### 배경

- 인기상품 목록 조회가 조회 요청 시 가장 성능적으로 문제가 될 수 있는 기능이라고 예상합니다.
- 주문(Order), 상품(Item) 등 여러 도메인에 걸쳐 있는 데이터를 통합적으로 분석해야 하기 때문입니다.
- 또한 단순한 조회가 아니라 집계, 정렬, 필터링 연산이 함께 수행되기 때문에 다른 단 순 조회 기능들보다 성능 부하가 클 것으로 예상됩니다.

### 기능 요구 사항

- 사용자는 인기 상품을 조회할 수 있습니다.
- 인기 상품은 최근 3일 간 가장 주문 수량이 많은 상품을 기준으로 정렬하여 5개를 조회합니다.
- 최근 3일 간이란 오늘부터 1일 전 ~ 3일 전까지 주문된 상품들을 의미합니다.

### 구현 방법

#### 1. 인기 상품 테이블을 두고 주문 시마다 주문 수량 집계를 할 수 있도록 하는 방법
- 장점
  - 별도 집계가 필요하지 않으므로 조회 속도가 빠름
- 단점
  - 주문이 발생할 때 마다 쓰기 부하가 발생
  - 동시성 이슈가 발생할 수 있음
#### 2. 인기 상품 조회 요청 시 주문, 주문상품, 상품 테이블을 JOIN하여 조회하도록 하는 방법
- 장점
  - 요청 시에 한 번에 JOIN SQL문 조회 요청을 하면 되므로 구현이 간단함
  - 실시간으로 주문 수량에 대한 정확한 데이터를 반영할 수 있음
- 단점
  - 주문이나 상품 데이터가 많을 경우 성능 문제 발생 가능
  - JOIN, 특정 기간 필터링을 하기 위해 인덱스 최적화가 필요
  - 조회 시 마다 필터링, GROUP BY 등 매번 연산을 수행해줘야 함
#### 3. 인기 상품 테이블을 두고 배치로 매일 한 번에 인기 상품 계산하여 저장하도록 하는 방법
- 장점
  - 주문 시에 따로 쓰기 요청이 들어가서 부하가 발생하지 않음
  - 미리 계산해놓고 조회하는 것이므로 조회 속도 빠름
- 단점
  - 실시간으로 주문 수량에 대한 정확한 데이터 반영이 어려움
  - 배치 실패 시 데이터 부정확할 가능성이 있음
#### 4. 인기 상품에 관한 캐시를 저장하는 방법
- 장점
  - Redis 등 캐시에서 집계된 인기 상품 결과를 저장하여 조회 요청 속도 빠름
  - 캐시를 사용하면 빠른 속도로 실시간 데이터 반영도 가능
- 단점
  - 캐시와 DB 간 데이터 불일치 가능성이 있음
  - Redis 등 추가적인 인프라가 필요
#### 5. CQRS 패턴으로 주문 생성 시 이벤트를 발행하고 이벤트 소비자가 조회 전용 저장소에 인기 상품 정보 업데이트하는 방법
- 장점
  - 읽기/쓰기 분리하여 성능을 최적화할 수 있음
  - 대용량 데이터일 경우에도 안정적으로 운용 가능
- 단점
  - 별도의 테이블 또는 인덱싱 DB에 저장하고 조회만 하도록 하기 위한 인프라가 필요
  - 초기 설계가 복잡할 수 있음
  - 읽기/쓰기 분리된 데이터에 대한 동기화가 필요

### 결론

처음에는 제일 구현이 간단한 JOIN 방식을 사용할 수 있을 것 같습니다. 

이 방법을 사용한다면 Order 테이블에서는 시간 조건으로 최근 1일 ~ 3일 전 데이터를 필터링 하기 위해 `created_at` 기준 범위 조회 속도를 높이기 위해 인덱스가 필요할 것 같습니다.

OrderItem 테이블에서는 조인을 위해 `order_id`, `item_id` 에 대한 인덱스가 필요할 것으로 보입니다.

Item 테이블은 조인을 위해 `id` 에 관한 인덱스가 필요할 것으로 보이는데 PK 이기 때문에 따로 설정할 필요는 없을 것 같습니다.

주문 데이터가 너무 많아지는 경우에는 일자 기준으로 DB 파티셔닝을 하는 방식으로도 성능을 개선할 수 있을 것 같습니다.

<br>

데이터가 많아질수록 성능 이슈가 발생할 수 있는데, 이 때는 인기 상품 데이터를 주기적으로 배치 처리하여 별도 테이블에 저장하고 조회하는 방식으로 개선하는 것이 좋을 것 같습니다.

인기 상품의 경우 실시간 데이터가 필요하지 않을 가능성이 더 크기 때문에 배치로 처리해도 괜찮을 것 같습니다.

처음에는 인기 상품 데이터를 한 번에 집계하고 배치로 반영할 때 상품 식별자만 가지고 Item 테이블과 조인하는 것으로 생각하였습니다. 

그러나 이미 통계 테이블에 배치로 데이터를 넣는 것으로 실시간성을 고려하지 않기로 하였기 때문에 통계 테이블 저장 시에 상품 정보도 함께 저장하는 것이 더 효율적일 것으로 생각됩니다.

<br>

이 방법으로도 성능에 문제가 발생하기 시작한다면 인프라 구축을 통해 캐시나 다른 DB를 활용하는 방법들을 고려해볼 수 있을 것 같습니다.
